<?php
declare(strict_types=1);

namespace Bandfront\Audio;

use Bandfront\Core\Config;
use Bandfront\Storage\FileManager;
use Bandfront\Utils\Debug;

// Set domain for Audio

/**
 * Audio Processor
 * 
 * Handles audio file metadata extraction and duration analysis
 * Demo creation functionality has been moved to DemoCreator class
 * 
 * @package Bandfront\Audio
 * @since 2.0.0
 */
class Processor {
    
    private Config $config;
    private FileManager $fileManager;
    
    /**
     * Constructor
     */
    public function __construct(Config $config, FileManager $fileManager) {
        $this->config = $config;
        $this->fileManager = $fileManager;
    }
    
    /**
     * Get audio duration from file
     * 
     * @param string $filepath File path
     * @return int Duration in seconds
     */
    public function getAudioDuration(string $filepath): int {
        // Try ffprobe first
        if ($duration = $this->getDurationViaFfprobe($filepath)) {
            return $duration;
        }
        
        // Fallback to getID3
        if (class_exists('getID3')) {
            $getID3 = new \getID3();
            $info = $getID3->analyze($filepath);
            if (!empty($info['playtime_seconds'])) {
                return (int) $info['playtime_seconds'];
            }
        }
        
        return 0;
    }
    
    /**
     * Get duration using ffprobe
     * 
     * @param string $filepath File path
     * @return int Duration or 0
     */
    private function getDurationViaFfprobe(string $filepath): int {
        $ffprobe = '/usr/bin/ffprobe'; // Adjust path as needed
        
        if (!file_exists($ffprobe)) {
            return 0;
        }
        
        $cmd = escapeshellcmd($ffprobe) . ' -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 ' . escapeshellarg($filepath);
        $duration = shell_exec($cmd);
        
        return $duration ? (int) round((float) $duration) : 0;
    }
}
